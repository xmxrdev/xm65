#pragma once

#include <stdbool.h>
#include <stdint.h>

#define RAM_SIZE 0x10000
#define DEREFERENCE true
#define NO_DEREFERENCE false

typedef enum {
    XM65_FLAG_C = 1u << 0,
    XM65_FLAG_Z = 1u << 1,
    XM65_FLAG_I = 1u << 2,
    XM65_FLAG_D = 1u << 3,
    XM65_FLAG_B = 1u << 4,
    XM65_FLAG_U = 1u << 5,
    XM65_FLAG_V = 1u << 6,
    XM65_FLAG_N = 1u << 7,
    XM65_FLAGS_NONE = 0,
    XM65_FLAGS_ALL = XM65_FLAG_C | XM65_FLAG_Z | XM65_FLAG_V | XM65_FLAG_N,
    XM65_FLAGS_ZN = XM65_FLAG_Z | XM65_FLAG_N,
} XM65_FLAG;

enum {
    XM65_VECTOR_NMI   = 0xFFFA,
    XM65_VECTOR_RESET = 0xFFFC,
    XM65_VECTOR_IRQ   = 0xFFFE,
};

typedef enum {
    XM65_OPCODE_ADC_IMM = 0x69,
    XM65_OPCODE_ADC_ZPG = 0x65,
    XM65_OPCODE_ADC_ZPG_X = 0x75,
    XM65_OPCODE_ADC_ABS = 0x6D,
    XM65_OPCODE_ADC_ABS_X = 0x7D,
    XM65_OPCODE_ADC_ABS_Y = 0x79,
    XM65_OPCODE_ADC_IND_X = 0x61,
    XM65_OPCODE_ADC_IND_Y = 0x71,

    XM65_OPCODE_AND_IMM = 0x29,
    XM65_OPCODE_AND_ZPG = 0x25,
    XM65_OPCODE_AND_ZPG_X = 0x35,
    XM65_OPCODE_AND_ABS = 0x2D,
    XM65_OPCODE_AND_ABS_X = 0x3D,
    XM65_OPCODE_AND_ABS_Y = 0x39,
    XM65_OPCODE_AND_IND_X = 0x21,
    XM65_OPCODE_AND_IND_Y = 0x31,

    XM65_OPCODE_ASL_A = 0x0A,
    XM65_OPCODE_ASL_ZPG = 0x06,
    XM65_OPCODE_ASL_ZPG_X = 0x16,
    XM65_OPCODE_ASL_ABS = 0x0E,
    XM65_OPCODE_ASL_ABS_X = 0x1E,

    XM65_OPCODE_BCC_REL = 0x90,

    XM65_OPCODE_BCS_REL = 0xB0,

    XM65_OPCODE_BEQ_REL = 0xF0,

    XM65_OPCODE_BIT_ZPG = 0x24,
    XM65_OPCODE_BIT_ABS = 0x2C,

    XM65_OPCODE_BMI_REL = 0x30,

    XM65_OPCODE_BNE_REL = 0xD0,

    XM65_OPCODE_BPL_REL = 0x10,

    XM65_OPCODE_BRK_IMP = 0x00,

    XM65_OPCODE_BVC_REL = 0x50,

    XM65_OPCODE_BVS_REL = 0x70,

    XM65_OPCODE_CLC_IMP = 0x18,

    XM65_OPCODE_CLD_IMP = 0xD8,

    XM65_OPCODE_CLI_IMP = 0x58,

    XM65_OPCODE_CLV_IMP = 0xB8,

    XM65_OPCODE_CMP_IMM = 0xC9,
    XM65_OPCODE_CMP_ZPG = 0xC5,
    XM65_OPCODE_CMP_ZPG_X = 0xD5,
    XM65_OPCODE_CMP_ABS = 0xCD,
    XM65_OPCODE_CMP_ABS_X = 0xDD,
    XM65_OPCODE_CMP_ABS_Y = 0xD9,
    XM65_OPCODE_CMP_IND_X = 0xC1,
    XM65_OPCODE_CMP_IND_Y = 0xD1,

    XM65_OPCODE_CPX_IMM = 0x0E,
    XM65_OPCODE_CPX_ZPG = 0xE4,
    XM65_OPCODE_CPX_ABS = 0xEC,

    XM65_OPCODE_CPY_IMM = 0xC0,
    XM65_OPCODE_CPY_ZPG = 0xC4,
    XM65_OPCODE_CPY_ABS = 0xCC,

    XM65_OPCODE_DEC_ZPG = 0xC6,
    XM65_OPCODE_DEC_ZPG_X = 0xD6,
    XM65_OPCODE_DEC_ABS = 0xCE,
    XM65_OPCODE_DEC_ABS_X = 0xDE,

    XM65_OPCODE_DEX_IMP = 0xCA,

    XM65_OPCODE_DEY_IMP = 0x88,

    XM65_OPCODE_EOR_IMM = 0x49,
    XM65_OPCODE_EOR_ZPG = 0x45,
    XM65_OPCODE_EOR_ZPG_X = 0x55,
    XM65_OPCODE_EOR_ABS = 0x4D,
    XM65_OPCODE_EOR_ABS_X = 0x5D,
    XM65_OPCODE_EOR_ABS_Y = 0x59,
    XM65_OPCODE_EOR_IND_X = 0x41,
    XM65_OPCODE_EOR_IND_Y = 0x51,

    XM65_OPCODE_INC_ZPG = 0xE6,
    XM65_OPCODE_INC_ZPG_X = 0xF6,
    XM65_OPCODE_INC_ABS = 0xEE,
    XM65_OPCODE_INC_ABS_X = 0xFE,

    XM65_OPCODE_INX_IMP = 0xE8,

    XM65_OPCODE_INY_IMP = 0xC8,

    XM65_OPCODE_JMP_ABS = 0x4C,
    XM65_OPCODE_JMP_IND = 0x6C,

    XM65_OPCODE_JSR_ABS = 0x20,

    XM65_OPCODE_LDA_IMM = 0xA9,
    XM65_OPCODE_LDA_ZPG = 0xA5,
    XM65_OPCODE_LDA_ZPG_X = 0xB5,
    XM65_OPCODE_LDA_ABS = 0xAD,
    XM65_OPCODE_LDA_ABS_X = 0xBD,
    XM65_OPCODE_LDA_ABS_Y = 0xB9,
    XM65_OPCODE_LDA_IND_X = 0xA1,
    XM65_OPCODE_LDA_IND_Y = 0xB1,

    XM65_OPCODE_LDX_IMM = 0xA2,
    XM65_OPCODE_LDX_ZPG = 0xA6,
    XM65_OPCODE_LDX_ZPG_Y = 0xB6,
    XM65_OPCODE_LDX_ABS = 0xAE,
    XM65_OPCODE_LDX_ABS_Y = 0xBE,

    XM65_OPCODE_LDY_IMM = 0xA0,
    XM65_OPCODE_LDY_ZPG = 0xA4,
    XM65_OPCODE_LDY_ZPG_X = 0xB4,
    XM65_OPCODE_LDY_ABS = 0xAC,
    XM65_OPCODE_LDY_ABS_X = 0xBC,

    XM65_OPCODE_LSR_IMM = 0x4A,
    XM65_OPCODE_LSR_ZPG = 0x46,
    XM65_OPCODE_LSR_ZPG_X = 0x56,
    XM65_OPCODE_LSR_ABS = 0x4E,
    XM65_OPCODE_LSR_ABS_X = 0x5E,

    XM65_OPCODE_NOP_IMP = 0xEA,

    XM65_OPCODE_ORA_IMM = 0x09,
    XM65_OPCODE_ORA_ZPG = 0x05,
    XM65_OPCODE_ORA_ZPG_X = 0x15,
    XM65_OPCODE_ORA_ABS = 0x0D,
    XM65_OPCODE_ORA_ABS_X = 0x1D,
    XM65_OPCODE_ORA_ABS_Y = 0x19,
    XM65_OPCODE_ORA_IND_X = 0x01,
    XM65_OPCODE_ORA_IND_Y = 0x11,

    XM65_OPCODE_PHA_IMP = 0x48,

    XM65_OPCODE_PHP_IMP = 0x08,

    XM65_OPCODE_PLA_IMP = 0x68,

    XM65_OPCODE_PLP_IMP = 0x28,

    XM65_OPCODE_ROL_A = 0x2A,
    XM65_OPCODE_ROL_ZPG = 0x26,
    XM65_OPCODE_ROL_ZPG_X = 0x36,
    XM65_OPCODE_ROL_ABS = 0x2E,
    XM65_OPCODE_ROL_ABS_X = 0x3E,

    XM65_OPCODE_ROR_A = 0x6A,
    XM65_OPCODE_ROR_ZPG = 0x66,
    XM65_OPCODE_ROR_ZPG_X = 0x76,
    XM65_OPCODE_ROR_ABS = 0x6E,
    XM65_OPCODE_ROR_ABS_X = 0x7E,

    XM65_OPCODE_RTI_IMP = 0x40,

    XM65_OPCODE_RTS_IMP = 0x60,

    XM65_OPCODE_SBC_IMM = 0xE9,
    XM65_OPCODE_SBC_ZPG = 0xE5,
    XM65_OPCODE_SBC_ZPG_X = 0xF5,
    XM65_OPCODE_SBC_ABS = 0xED,
    XM65_OPCODE_SBC_ABS_X = 0xFD,
    XM65_OPCODE_SBC_ABS_Y = 0xF9,
    XM65_OPCODE_SBC_IND_X = 0xE1,
    XM65_OPCODE_SBC_IND_Y = 0xF1,

    XM65_OPCODE_SEC_IMP = 0x38,

    XM65_OPCODE_SED_IMP = 0xF8,

    XM65_OPCODE_SEI_IMP = 0x78,

    XM65_OPCODE_STA_ZPG = 0x85,
    XM65_OPCODE_STA_ZPG_X = 0x95,
    XM65_OPCODE_STA_ABS = 0x8D,
    XM65_OPCODE_STA_ABS_X = 0x9D,
    XM65_OPCODE_STA_ABS_Y = 0x99,
    XM65_OPCODE_STA_IND_X = 0x81,
    XM65_OPCODE_STA_IND_Y = 0x91,

    XM65_OPCODE_STX_ZPG = 0x86,
    XM65_OPCODE_STX_ZPG_Y = 0x96,
    XM65_OPCODE_STX_ABS = 0x8E,

    XM65_OPCODE_STY_ZPG = 0x84,
    XM65_OPCODE_STY_ZPG_X = 0x94,
    XM65_OPCODE_STY_ABS = 0x8C,

    XM65_OPCODE_TAX_IMP = 0xAA,

    XM65_OPCODE_TAY_IMP = 0xA8,

    XM65_OPCODE_TSX_IMP = 0xBA,

    XM65_OPCODE_TXA_IMP = 0x8A,

    XM65_OPCODE_TXS_IMP = 0x9A,

    XM65_OPCODE_TYA_IMP = 0x98,
} XM65_OPCODE;

typedef enum {
    XM65_VM_STATUS_IDLE,
    XM65_VM_STATUS_RUNNING,
    XM65_VM_STATUS_INTERRUPTED,
} XM65_VM_STATUS;

typedef struct XM65_6502 {
    uint8_t a, x, y, sp, p;
    uint16_t pc;
    uint64_t cycles;
} XM65_6502;

typedef struct XM65_RAM {
    uint8_t data[RAM_SIZE];
} XM65_RAM;

typedef struct XM65_VM {
    XM65_RAM ram;
    XM65_6502 cpu;
    XM65_VM_STATUS status;
} XM65_VM;

void XM65_PrintCPU(XM65_VM*);
void XM65_UpdateFlags(XM65_VM*, uint16_t, uint16_t, XM65_FLAG);
uint16_t XM65_ReadVector(XM65_VM*, uint16_t);
uint8_t XM65_ReadOperand(XM65_VM*);
uint16_t XM65_ReadIndirectOffset(XM65_VM*, uint8_t, uint8_t, bool);
uint16_t XM65_ReadIndirectAbsolute(XM65_VM*, bool);
uint16_t XM65_ReadAbsolute(XM65_VM*, uint8_t, bool);
uint16_t XM65_AddCarry(XM65_VM*, uint8_t);
uint16_t XM65_SubstractCarry(XM65_VM*, uint8_t);
void XM65_ProgramVM(XM65_VM*, const char*);
void XM65_Power_VM(XM65_VM*, bool);
void XM65_ResetVM(XM65_VM*);
XM65_VM_STATUS XM65_RunVM(XM65_VM*);
void XM65_StackPush(XM65_VM*, uint8_t);
uint8_t XM65_StackPull(XM65_VM*);
